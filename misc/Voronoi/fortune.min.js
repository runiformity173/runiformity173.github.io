function Voronoi(){this.vertices=null,this.edges=null,this.cells=null,this.toRecycle=null,this.beachsectionJunkyard=[],this.circleEventJunkyard=[],this.vertexJunkyard=[],this.edgeJunkyard=[],this.cellJunkyard=[]}Voronoi.prototype.reset=function(){if(this.beachline||(this.beachline=new this.RBTree),this.beachline.root)for(var e=this.beachline.getFirst(this.beachline.root);e;)this.beachsectionJunkyard.push(e),e=e.rbNext;this.beachline.root=null,this.circleEvents||(this.circleEvents=new this.RBTree),this.circleEvents.root=this.firstCircleEvent=null,this.vertices=[],this.edges=[],this.cells=[]},Voronoi.prototype.sqrt=Math.sqrt,Voronoi.prototype.abs=Math.abs,Voronoi.prototype.ε=Voronoi.ε=1e-9,Voronoi.prototype.invε=Voronoi.invε=1/Voronoi.ε,Voronoi.prototype.equalWithEpsilon=function(e,t){return this.abs(e-t)<1e-9},Voronoi.prototype.greaterThanWithEpsilon=function(e,t){return 1e-9<e-t},Voronoi.prototype.greaterThanOrEqualWithEpsilon=function(e,t){return t-e<1e-9},Voronoi.prototype.lessThanWithEpsilon=function(e,t){return 1e-9<t-e},Voronoi.prototype.lessThanOrEqualWithEpsilon=function(e,t){return e-t<1e-9},Voronoi.prototype.RBTree=function(){this.root=null},Voronoi.prototype.RBTree.prototype.rbInsertSuccessor=function(e,t){var r,i,o;if(e){if(t.rbPrevious=e,t.rbNext=e.rbNext,e.rbNext&&(e.rbNext.rbPrevious=t),e.rbNext=t,e.rbRight){for(e=e.rbRight;e.rbLeft;)e=e.rbLeft;e.rbLeft=t}else e.rbRight=t;r=e}else r=this.root?(e=this.getFirst(this.root),t.rbPrevious=null,(t.rbNext=e).rbPrevious=t,e.rbLeft=t,e):(t.rbPrevious=t.rbNext=null,this.root=t,null);for(t.rbLeft=t.rbRight=null,t.rbParent=r,t.rbRed=!0,e=t;r&&r.rbRed;)r===(i=r.rbParent).rbLeft?(o=i.rbRight)&&o.rbRed?(r.rbRed=o.rbRed=!1,i.rbRed=!0,e=i):(e===r.rbRight&&(this.rbRotateLeft(r),r=(e=r).rbParent),r.rbRed=!1,i.rbRed=!0,this.rbRotateRight(i)):(o=i.rbLeft)&&o.rbRed?(r.rbRed=o.rbRed=!1,i.rbRed=!0,e=i):(e===r.rbLeft&&(this.rbRotateRight(r),r=(e=r).rbParent),r.rbRed=!1,i.rbRed=!0,this.rbRotateLeft(i)),r=e.rbParent;this.root.rbRed=!1},Voronoi.prototype.RBTree.prototype.rbRemoveNode=function(e){e.rbNext&&(e.rbNext.rbPrevious=e.rbPrevious),e.rbPrevious&&(e.rbPrevious.rbNext=e.rbNext),e.rbNext=e.rbPrevious=null;var t,r,i=e.rbParent,o=e.rbLeft,s=e.rbRight,n=o?s?this.getFirst(s):o:s;if(i?i.rbLeft===e?i.rbLeft=n:i.rbRight=n:this.root=n,o&&s?(t=n.rbRed,n.rbRed=e.rbRed,((n.rbLeft=o).rbParent=n)!==s?(i=n.rbParent,n.rbParent=e.rbParent,e=n.rbRight,i.rbLeft=e,(n.rbRight=s).rbParent=n):(n.rbParent=i,e=(i=n).rbRight)):(t=e.rbRed,e=n),e&&(e.rbParent=i),!t)if(e&&e.rbRed)e.rbRed=!1;else{do{if(e===this.root)break;if(e===i.rbLeft){if((r=i.rbRight).rbRed&&(r.rbRed=!1,i.rbRed=!0,this.rbRotateLeft(i),r=i.rbRight),r.rbLeft&&r.rbLeft.rbRed||r.rbRight&&r.rbRight.rbRed){r.rbRight&&r.rbRight.rbRed||(r.rbLeft.rbRed=!1,r.rbRed=!0,this.rbRotateRight(r),r=i.rbRight),r.rbRed=i.rbRed,i.rbRed=r.rbRight.rbRed=!1,this.rbRotateLeft(i),e=this.root;break}}else if((r=i.rbLeft).rbRed&&(r.rbRed=!1,i.rbRed=!0,this.rbRotateRight(i),r=i.rbLeft),r.rbLeft&&r.rbLeft.rbRed||r.rbRight&&r.rbRight.rbRed){r.rbLeft&&r.rbLeft.rbRed||(r.rbRight.rbRed=!1,r.rbRed=!0,this.rbRotateLeft(r),r=i.rbLeft),r.rbRed=i.rbRed,i.rbRed=r.rbLeft.rbRed=!1,this.rbRotateRight(i),e=this.root;break}}while(r.rbRed=!0,i=(e=i).rbParent,!e.rbRed);e&&(e.rbRed=!1)}},Voronoi.prototype.RBTree.prototype.rbRotateLeft=function(e){var t=e,r=e.rbRight,e=t.rbParent;e?e.rbLeft===t?e.rbLeft=r:e.rbRight=r:this.root=r,r.rbParent=e,t.rbParent=r,t.rbRight=r.rbLeft,t.rbRight&&(t.rbRight.rbParent=t),r.rbLeft=t},Voronoi.prototype.RBTree.prototype.rbRotateRight=function(e){var t=e,r=e.rbLeft,e=t.rbParent;e?e.rbLeft===t?e.rbLeft=r:e.rbRight=r:this.root=r,r.rbParent=e,t.rbParent=r,t.rbLeft=r.rbRight,t.rbLeft&&(t.rbLeft.rbParent=t),r.rbRight=t},Voronoi.prototype.RBTree.prototype.getFirst=function(e){for(;e.rbLeft;)e=e.rbLeft;return e},Voronoi.prototype.RBTree.prototype.getLast=function(e){for(;e.rbRight;)e=e.rbRight;return e},Voronoi.prototype.Diagram=function(e){this.site=e},Voronoi.prototype.Cell=function(e){this.site=e,this.halfedges=[],this.closeMe=!1},Voronoi.prototype.Cell.prototype.init=function(e){return this.site=e,this.halfedges=[],this.closeMe=!1,this},Voronoi.prototype.createCell=function(e){var t=this.cellJunkyard.pop();return t?t.init(e):new this.Cell(e)},Voronoi.prototype.Cell.prototype.prepareHalfedges=function(){for(var e,t=this.halfedges,r=t.length;r--;)(e=t[r].edge).vb&&e.va||t.splice(r,1);return t.sort(function(e,t){return t.angle-e.angle}),t.length},Voronoi.prototype.Cell.prototype.getNeighborIds=function(){for(var e,t=[],r=this.halfedges.length;r--;)null!==(e=this.halfedges[r].edge).lSite&&e.lSite.voronoiId!=this.site.voronoiId?t.push(e.lSite.voronoiId):null!==e.rSite&&e.rSite.voronoiId!=this.site.voronoiId&&t.push(e.rSite.voronoiId);return t},Voronoi.prototype.Cell.prototype.getBbox=function(){for(var e,t,r=this.halfedges,i=r.length,o=1/0,s=1/0,n=-1/0,h=-1/0;i--;)(e=(t=r[i].getStartpoint()).x)<o&&(o=e),(t=t.y)<s&&(s=t),n<e&&(n=e),h<t&&(h=t);return{x:o,y:s,width:n-o,height:h-s}},Voronoi.prototype.Cell.prototype.pointIntersection=function(e,t){for(var r,i,o=this.halfedges,s=o.length;s--;){if(i=(r=o[s]).getStartpoint(),r=r.getEndpoint(),!(i=(t-i.y)*(r.x-i.x)-(e-i.x)*(r.y-i.y)))return 0;if(0<i)return-1}return 1},Voronoi.prototype.Vertex=function(e,t){this.x=e,this.y=t},Voronoi.prototype.Edge=function(e,t){this.lSite=e,this.rSite=t,this.va=this.vb=null},Voronoi.prototype.Halfedge=function(e,t,r){var i;this.site=t,this.edge=e,r?this.angle=Math.atan2(r.y-t.y,r.x-t.x):(i=e.va,r=e.vb,this.angle=e.lSite===t?Math.atan2(r.x-i.x,i.y-r.y):Math.atan2(i.x-r.x,r.y-i.y))},Voronoi.prototype.createHalfedge=function(e,t,r){return new this.Halfedge(e,t,r)},Voronoi.prototype.Halfedge.prototype.getStartpoint=function(){return this.edge.lSite===this.site?this.edge.va:this.edge.vb},Voronoi.prototype.Halfedge.prototype.getEndpoint=function(){return this.edge.lSite===this.site?this.edge.vb:this.edge.va},Voronoi.prototype.createVertex=function(e,t){var r=this.vertexJunkyard.pop();return r?(r.x=e,r.y=t):r=new this.Vertex(e,t),this.vertices.push(r),r},Voronoi.prototype.createEdge=function(e,t,r,i){var o=this.edgeJunkyard.pop();return o?(o.lSite=e,o.rSite=t,o.va=o.vb=null):o=new this.Edge(e,t),this.edges.push(o),r&&this.setEdgeStartpoint(o,e,t,r),i&&this.setEdgeEndpoint(o,e,t,i),this.cells[e.voronoiId].halfedges.push(this.createHalfedge(o,e,t)),this.cells[t.voronoiId].halfedges.push(this.createHalfedge(o,t,e)),o},Voronoi.prototype.createBorderEdge=function(e,t,r){var i=this.edgeJunkyard.pop();return i?(i.lSite=e,i.rSite=null):i=new this.Edge(e,null),i.va=t,i.vb=r,this.edges.push(i),i},Voronoi.prototype.setEdgeStartpoint=function(e,t,r,i){e.va||e.vb?e.lSite===r?e.vb=i:e.va=i:(e.va=i,e.lSite=t,e.rSite=r)},Voronoi.prototype.setEdgeEndpoint=function(e,t,r,i){this.setEdgeStartpoint(e,r,t,i)},Voronoi.prototype.Beachsection=function(){},Voronoi.prototype.createBeachsection=function(e){var t=this.beachsectionJunkyard.pop();return(t=t||new this.Beachsection).site=e,t},Voronoi.prototype.leftBreakPoint=function(e,t){var r=e.site,i=r.x,o=r.y,s=o-t;if(!s)return i;var n=e.rbPrevious;if(!n)return-1/0;var h=(r=n.site).x,a=r.y,e=a-t;if(!e)return h;n=h-i,r=1/s-1/e,t=n/e;return r?(-t+this.sqrt(t*t-2*r*(n*n/(-2*e)-a+e/2+o-s/2)))/r+i:(i+h)/2},Voronoi.prototype.rightBreakPoint=function(e,t){var r=e.rbNext;if(r)return this.leftBreakPoint(r,t);e=e.site;return e.y===t?e.x:1/0},Voronoi.prototype.detachBeachsection=function(e){this.detachCircleEvent(e),this.beachline.rbRemoveNode(e),this.beachsectionJunkyard.push(e)},Voronoi.prototype.removeBeachsection=function(e){var t=e.circleEvent,r=t.x,i=t.ycenter,o=this.createVertex(r,i),s=e.rbPrevious,n=e.rbNext,h=[e],a=Math.abs;this.detachBeachsection(e);for(var l=s;l.circleEvent&&a(r-l.circleEvent.x)<1e-9&&a(i-l.circleEvent.ycenter)<1e-9;)s=l.rbPrevious,h.unshift(l),this.detachBeachsection(l),l=s;h.unshift(l),this.detachCircleEvent(l);for(var c=n;c.circleEvent&&a(r-c.circleEvent.x)<1e-9&&a(i-c.circleEvent.ycenter)<1e-9;)n=c.rbNext,h.push(c),this.detachBeachsection(c),c=n;h.push(c),this.detachCircleEvent(c);for(var b=h.length,f=1;f<b;f++)c=h[f],l=h[f-1],this.setEdgeStartpoint(c.edge,l.site,c.site,o);l=h[0],(c=h[b-1]).edge=this.createEdge(l.site,c.site,void 0,o),this.attachCircleEvent(l),this.attachCircleEvent(c)},Voronoi.prototype.addBeachsection=function(e){for(var t,r,i,o,s=e.x,n=e.y,h=this.beachline.root;h;)if(1e-9<(i=this.leftBreakPoint(h,n)-s))h=h.rbLeft;else{if(!(1e-9<(o=s-this.rightBreakPoint(h,n)))){-1e-9<i?(t=h.rbPrevious,r=h):-1e-9<o?r=(t=h).rbNext:t=r=h;break}if(!h.rbRight){t=h;break}h=h.rbRight}var a,l,c,b,f,u,p,d,y,g,v,R=this.createBeachsection(e);if(this.beachline.rbInsertSuccessor(t,R),t||r){if(t===r)return this.detachCircleEvent(t),r=this.createBeachsection(t.site),this.beachline.rbInsertSuccessor(R,r),R.edge=r.edge=this.createEdge(t.site,R.site),this.attachCircleEvent(t),void this.attachCircleEvent(r);!t||r?t!==r&&(this.detachCircleEvent(t),this.detachCircleEvent(r),l=(a=t.site).x,v=a.y,c=e.x-l,b=e.y-v,u=(f=r.site).x-l,d=2*(c*(p=f.y-v)-b*u),y=c*c+b*b,g=u*u+p*p,v=this.createVertex((p*y-b*g)/d+l,(c*g-u*y)/d+v),this.setEdgeStartpoint(r.edge,a,f,v),R.edge=this.createEdge(a,e,void 0,v),r.edge=this.createEdge(e,f,void 0,v),this.attachCircleEvent(t),this.attachCircleEvent(r)):R.edge=this.createEdge(t.site,R.site)}},Voronoi.prototype.CircleEvent=function(){this.arc=null,this.rbLeft=null,this.rbNext=null,this.rbParent=null,this.rbPrevious=null,this.rbRed=!1,this.rbRight=null,this.site=null,this.x=this.y=this.ycenter=0},Voronoi.prototype.attachCircleEvent=function(e){var t=e.rbPrevious,r=e.rbNext;if(t&&r){var i=t.site,o=e.site,s=r.site;if(i!==s){var n=o.x,h=o.y,a=i.x-n,l=i.y-h,c=s.x-n,t=s.y-h,r=2*(a*t-l*c);if(!(-2e-12<=r)){var i=a*a+l*l,s=c*c+t*t,l=(t*i-l*s)/r,r=(a*s-c*i)/r,h=r+h,b=this.circleEventJunkyard.pop();(b=b||new this.CircleEvent).arc=e,b.site=o,b.x=l+n,b.y=h+this.sqrt(l*l+r*r),b.ycenter=h,e.circleEvent=b;for(var f=null,u=this.circleEvents.root;u;)if(b.y<u.y||b.y===u.y&&b.x<=u.x){if(!u.rbLeft){f=u.rbPrevious;break}u=u.rbLeft}else{if(!u.rbRight){f=u;break}u=u.rbRight}this.circleEvents.rbInsertSuccessor(f,b),f||(this.firstCircleEvent=b)}}}},Voronoi.prototype.detachCircleEvent=function(e){var t=e.circleEvent;t&&(t.rbPrevious||(this.firstCircleEvent=t.rbNext),this.circleEvents.rbRemoveNode(t),this.circleEventJunkyard.push(t),e.circleEvent=null)},Voronoi.prototype.connectEdge=function(e,t){var r=e.vb;if(r)return!0;var i,o,s=e.va,n=t.xl,h=t.xr,a=t.yt,l=t.yb,c=e.lSite,b=e.rSite,f=c.x,u=c.y,p=b.x,d=b.y,y=(f+p)/2,t=(u+d)/2;if(this.cells[c.voronoiId].closeMe=!0,this.cells[b.voronoiId].closeMe=!0,d!==u&&(o=t-(i=(f-p)/(d-u))*y),void 0===i){if(y<n||h<=y)return!1;if(p<f){if(!s||s.y<a)s=this.createVertex(y,a);else if(s.y>=l)return!1;r=this.createVertex(y,l)}else{if(!s||s.y>l)s=this.createVertex(y,l);else if(s.y<a)return!1;r=this.createVertex(y,a)}}else if(i<-1||1<i)if(p<f){if(!s||s.y<a)s=this.createVertex((a-o)/i,a);else if(s.y>=l)return!1;r=this.createVertex((l-o)/i,l)}else{if(!s||s.y>l)s=this.createVertex((l-o)/i,l);else if(s.y<a)return!1;r=this.createVertex((a-o)/i,a)}else if(u<d){if(!s||s.x<n)s=this.createVertex(n,i*n+o);else if(s.x>=h)return!1;r=this.createVertex(h,i*h+o)}else{if(!s||s.x>h)s=this.createVertex(h,i*h+o);else if(s.x<n)return!1;r=this.createVertex(n,i*n+o)}return e.va=s,e.vb=r,!0},Voronoi.prototype.clipEdge=function(e,t){var r=e.va.x,i=e.va.y,o=0,s=1,n=e.vb.x-r,h=e.vb.y-i,a=r-t.xl;if(0==n&&a<0)return!1;var l=-a/n;if(n<0){if(l<o)return!1;l<s&&(s=l)}else if(0<n){if(s<l)return!1;o<l&&(o=l)}if(a=t.xr-r,0==n&&a<0)return!1;if(l=a/n,n<0){if(s<l)return!1;o<l&&(o=l)}else if(0<n){if(l<o)return!1;l<s&&(s=l)}if(a=i-t.yt,0==h&&a<0)return!1;if(l=-a/h,h<0){if(l<o)return!1;l<s&&(s=l)}else if(0<h){if(s<l)return!1;o<l&&(o=l)}if(a=t.yb-i,0==h&&a<0)return!1;if(l=a/h,h<0){if(s<l)return!1;o<l&&(o=l)}else if(0<h){if(l<o)return!1;l<s&&(s=l)}return 0<o&&(e.va=this.createVertex(r+o*n,i+o*h)),s<1&&(e.vb=this.createVertex(r+s*n,i+s*h)),(0<o||s<1)&&(this.cells[e.lSite.voronoiId].closeMe=!0,this.cells[e.rSite.voronoiId].closeMe=!0),!0},Voronoi.prototype.clipEdges=function(e){for(var t,r=this.edges,i=r.length,o=Math.abs;i--;)t=r[i],this.connectEdge(t,e)&&this.clipEdge(t,e)&&!(o(t.va.x-t.vb.x)<1e-9&&o(t.va.y-t.vb.y)<1e-9)||(t.va=t.vb=null,r.splice(i,1))},Voronoi.prototype.closeCells=function(e){for(var t,r,i,o,s,n,h,a,l,c=e.xl,b=e.xr,f=e.yt,u=e.yb,p=this.cells,d=p.length,y=Math.abs;d--;)if(t=p[d],t.prepareHalfedges()&&t.closeMe){for(o=(i=t.halfedges).length,r=0;r<o;){if(n=i[r].getEndpoint(),a=i[(r+1)%o].getStartpoint(),1e-9<=y(n.x-a.x)||1e-9<=y(n.y-a.y))switch(!0){case this.equalWithEpsilon(n.x,c)&&this.lessThanWithEpsilon(n.y,u):if(l=this.equalWithEpsilon(a.x,c),h=this.createVertex(c,l?a.y:u),s=this.createBorderEdge(t.site,n,h),r++,i.splice(r,0,this.createHalfedge(s,t.site,null)),o++,l)break;n=h;case this.equalWithEpsilon(n.y,u)&&this.lessThanWithEpsilon(n.x,b):if(l=this.equalWithEpsilon(a.y,u),h=this.createVertex(l?a.x:b,u),s=this.createBorderEdge(t.site,n,h),r++,i.splice(r,0,this.createHalfedge(s,t.site,null)),o++,l)break;n=h;case this.equalWithEpsilon(n.x,b)&&this.greaterThanWithEpsilon(n.y,f):if(l=this.equalWithEpsilon(a.x,b),h=this.createVertex(b,l?a.y:f),s=this.createBorderEdge(t.site,n,h),r++,i.splice(r,0,this.createHalfedge(s,t.site,null)),o++,l)break;n=h;case this.equalWithEpsilon(n.y,f)&&this.greaterThanWithEpsilon(n.x,c):if(l=this.equalWithEpsilon(a.y,f),h=this.createVertex(l?a.x:c,f),s=this.createBorderEdge(t.site,n,h),r++,i.splice(r,0,this.createHalfedge(s,t.site,null)),o++,l)break;if(n=h,l=this.equalWithEpsilon(a.x,c),h=this.createVertex(c,l?a.y:u),s=this.createBorderEdge(t.site,n,h),r++,i.splice(r,0,this.createHalfedge(s,t.site,null)),o++,l)break;if(n=h,l=this.equalWithEpsilon(a.y,u),h=this.createVertex(l?a.x:b,u),s=this.createBorderEdge(t.site,n,h),r++,i.splice(r,0,this.createHalfedge(s,t.site,null)),o++,l)break;if(n=h,l=this.equalWithEpsilon(a.x,b),h=this.createVertex(b,l?a.y:f),s=this.createBorderEdge(t.site,n,h),r++,i.splice(r,0,this.createHalfedge(s,t.site,null)),o++,l)break;default:throw"Voronoi.closeCells() > this makes no sense!"}r++}t.closeMe=!1}},Voronoi.prototype.quantizeSites=function(e){for(var t,r=this.ε,i=e.length;i--;)(t=e[i]).x=Math.floor(t.x/r)*r,t.y=Math.floor(t.y/r)*r},Voronoi.prototype.recycle=function(e){if(e){if(!(e instanceof this.Diagram))throw"Voronoi.recycleDiagram() > Need a Diagram object.";this.toRecycle=e}},Voronoi.prototype.compute=function(e,t){var r=new Date;this.reset(),this.toRecycle&&(this.vertexJunkyard=this.vertexJunkyard.concat(this.toRecycle.vertices),this.edgeJunkyard=this.edgeJunkyard.concat(this.toRecycle.edges),this.cellJunkyard=this.cellJunkyard.concat(this.toRecycle.cells),this.toRecycle=null);var i=e.slice(0);i.sort(function(e,t){var r=t.y-e.y;return r||t.x-e.x});for(var o,s,n,h=i.pop(),a=0,l=this.cells;;)if(n=this.firstCircleEvent,h&&(!n||h.y<n.y||h.y===n.y&&h.x<n.x))h.x===o&&h.y===s||(l[a]=this.createCell(h),h.voronoiId=a++,this.addBeachsection(h),s=h.y,o=h.x),h=i.pop();else{if(!n)break;this.removeBeachsection(n.arc)}this.clipEdges(t),this.closeCells(t);e=new Date,t=new this.Diagram;return t.cells=this.cells,t.edges=this.edges,t.vertices=this.vertices,t.execTime=e.getTime()-r.getTime(),this.reset(),t},"undefined"!=typeof module&&(module.exports=Voronoi);